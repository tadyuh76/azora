<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AvaloniaAzora.ViewModels.Admin"
             xmlns:models="using:AvaloniaAzora.Models"
             x:Class="AvaloniaAzora.Views.Admin.AuditLogsView"
             x:DataType="vm:AuditLogsViewModel">

    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Header -->
        <StackPanel Grid.Row="0" Spacing="8" Margin="0,0,0,24">
            <TextBlock Text="Audit Logs & System Activity" 
                       FontSize="24"
                       FontWeight="Bold"
                       Foreground="#1F2937"/>
            <TextBlock Text="Monitor system events and user actions for security and compliance" 
                       FontSize="14"
                       Foreground="#6B7280"/>
        </StackPanel>

        <!-- Statistics & Controls -->
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" Margin="0,0,0,24">
            <!-- Statistics Cards -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16">
                <Border Background="White" CornerRadius="8" Padding="20" BoxShadow="0 2 10 0 #00000010">
                    <StackPanel Spacing="8">
                        <TextBlock Text="{Binding AuditStatistics[TotalLogs]}" FontSize="24" FontWeight="Bold"/>
                        <TextBlock Text="Total Logs" FontSize="14" Foreground="#6B7280"/>
                    </StackPanel>
                </Border>
                <Border Background="White" CornerRadius="8" Padding="20" BoxShadow="0 2 10 0 #00000010">
                    <StackPanel Spacing="8">
                        <TextBlock Text="{Binding AuditStatistics[UniqueUsers]}" FontSize="24" FontWeight="Bold"/>
                        <TextBlock Text="Unique Actors" FontSize="14" Foreground="#6B7280"/>
                    </StackPanel>
                </Border>
                <!-- Add more stats if needed -->
            </StackPanel>

            <!-- Cleanup Button -->
            <Button Grid.Column="1"
                    Content="Cleanup Old Logs"
                    Command="{Binding CleanupOldLogsCommand}"
                    Height="40"
                    Background="#EF4444"
                    Foreground="White"
                    BorderThickness="0"
                    CornerRadius="6"
                    FontSize="14"
                    Padding="20,0"
                    VerticalAlignment="Bottom">
                <ToolTip.Tip>Cleans logs older than 1 year</ToolTip.Tip>
            </Button>
        </Grid>
        
        <!-- Main Content Area -->
        <Grid Grid.Row="2" RowDefinitions="Auto,*">
            <!-- Filter Controls -->
            <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="16" Margin="0,0,0,16">
                <!-- Search Box -->
                <TextBox Grid.Column="0"
                         Text="{Binding SearchText}"
                         Watermark="Search logs by description, user, or IP..."
                         FontSize="14"
                         Height="40"
                         Background="White"
                         BorderBrush="#E5E7EB"
                         CornerRadius="6"/>

                <!-- Event Type Filter -->
                <ComboBox Grid.Column="1"
                          ItemsSource="{Binding AvailableEventTypes}"
                          SelectedItem="{Binding SelectedEventType}"
                          Width="180"
                          Height="40"
                          FontSize="14"
                          Background="White"
                          BorderBrush="#E5E7EB"
                          CornerRadius="6"/>

                <!-- Date Filters -->
                <DatePicker Grid.Column="2"
                            SelectedDate="{Binding FromDate}"
                            Height="40"
                            Width="150"
                            FontSize="14"
                            Background="White"
                            BorderBrush="#E5E7EB"
                            CornerRadius="6"/>
                <DatePicker Grid.Column="3"
                            SelectedDate="{Binding ToDate}"
                            Height="40"
                            Width="150"
                            FontSize="14"
                            Background="White"
                            BorderBrush="#E5E7EB"
                            CornerRadius="6"/>

                <!-- Refresh Button -->
                <Button Grid.Column="4"
                        Content="Refresh"
                        Command="{Binding LoadLogsCommand}"
                        Height="40"
                        Background="#6B7280"
                        Foreground="White"
                        CornerRadius="6"/>
            </Grid>

            <!-- Logs DataGrid -->
            <Border Grid.Row="1"
                    Background="White"
                    BorderBrush="#E5E7EB"
                    BorderThickness="1"
                    CornerRadius="8">
                <DataGrid ItemsSource="{Binding FilteredLogs}"
                          SelectedItem="{Binding SelectedLog}"
                          IsReadOnly="True"
                          GridLinesVisibility="Horizontal"
                          HeadersVisibility="Column">
                    
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Timestamp" 
                                            Binding="{Binding Timestamp, StringFormat='yyyy-MM-dd HH:mm:ss'}"
                                            Width="160"/>
                        <DataGridTextColumn Header="User" 
                                            Binding="{Binding User.FullName}"
                                            Width="150"/>
                        <DataGridTextColumn Header="Event Type" 
                                            Binding="{Binding EventType}"
                                            Width="150"/>
                        <DataGridTextColumn Header="Description" 
                                            Binding="{Binding Description}"
                                            Width="*"/>
                        <DataGridTextColumn Header="Affected ID" 
                                            Binding="{Binding AffectedRowId}"
                                            Width="100"/>
                        
                        <DataGridTemplateColumn Header="Details" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate x:DataType="models:Log">
                                    <Button Content="View JSON"
                                            Command="{Binding $parent[DataGrid].((vm:AuditLogsViewModel)DataContext).ViewLogDetailsCommand}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding OldValue, Converter={StaticResource IsNotNullConverter}}"
                                            Background="#EBF4FF"
                                            Foreground="#3B82F6"
                                            FontSize="12"
                                            Padding="8,4"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Border>
        </Grid>

        <!-- Log Detail Dialog -->
        <Border Grid.Row="0" Grid.RowSpan="3"
                Background="#80000000"
                IsVisible="{Binding IsDetailDialogOpen}"
                ZIndex="1000">
            <Border Background="White"
                    CornerRadius="12"
                    MaxWidth="700" MaxHeight="600"
                    Padding="24"
                    HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel Spacing="16">
                    <TextBlock Text="Log Details" FontSize="20" FontWeight="Bold"/>
                    <TextBlock Text="{Binding SelectedLog.Timestamp, StringFormat='Timestamp: yyyy-MM-dd HH:mm:ss'}"/>
                    <TextBlock Text="{Binding SelectedLog.User.FullName, StringFormat='User: {0}'}"/>
                    <TextBlock Text="{Binding SelectedLog.EventType, StringFormat='Event: {0}'}"/>
                    <TextBlock Text="{Binding SelectedLog.Description, StringFormat='Description: {0}'}"/>
                    
                    <Expander Header="Old Values (JSON)" IsVisible="{Binding SelectedLog.OldValue, Converter={StaticResource IsNotNullConverter}}">
                        <ScrollViewer MaxHeight="150">
                            <TextBox Text="{Binding SelectedLog.OldValue, StringFormat={}{0}}" IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True"/>
                        </ScrollViewer>
                    </Expander>
                    
                    <Expander Header="New Values (JSON)" IsVisible="{Binding SelectedLog.NewValue, Converter={StaticResource IsNotNullConverter}}">
                        <ScrollViewer MaxHeight="150">
                            <TextBox Text="{Binding SelectedLog.NewValue, StringFormat={}{0}}" IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True"/>
                        </ScrollViewer>
                    </Expander>
                    
                    <Button Content="Close" 
                            Command="{Binding #IsDetailDialogOpen.SetToFalse}" 
                            HorizontalAlignment="Right"/>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
